/*
 * Project name:
     ihm.vtft
 * Generated by:
     Visual TFT
 * Date of creation
     20/09/2015
 * Time of creation
     17:55:03
 * Test configuration:
     MCU:             P32MX460F512L
                      http://www.microchip.com/wwwproducts/Devices.aspx?product=PIC32MX460F512L
     Dev.Board:       MikroMMB_for_PIC32_hw_rev_1.10
                      http://www.mikroe.com/mikromedia/pic32/
     Oscillator:      80000000 Hz
     SW:              mikroC PRO for PIC32
                      http://www.mikroe.com/mikroc/pic32/
 */

#include "ihm_objects.h"
#include "ihm_resources.h"
#include "USBdsc.c"

#define USB_LENGTH 64
#define IMAGE_SIZE 1024
#define IMAGE_COLOR_DEPTH 2

char ind1 = 0, ind1_old = 1;
char ind2 = 0, ind2_old = 1;
int ind_num = 0, ind_num_old = 1;

unsigned int Image_icon[1024] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,35921,35921,35921,35921,35921,35921,35921,35921,35921,35921,35921,35921,48599,35921,52851,35921,52851,4096,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,35921,0,0,0,0,0,0,0,0,0,0,0,48599,35921,52851,35921,52851,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,35921,0,544,1344,544,0,0,0,544,1344,544,0,48599,16936,52857,16936,52851,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,35921,0,1344,0,1344,0,0,0,1344,0,1344,0,48599,52851,52851,52851,52851,4096,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,35921,544,1344,0,1344,544,0,544,1344,0,1344,544,48599,52857,16936,52857,52851,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,35921,1344,544,0,544,1344,0,1344,544,0,544,1344,48599,16936,65139,16936,52851,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,35921,1344,0,0,0,1344,0,1344,0,0,0,1344,48599,16936,65139,16936,52851,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,35921,0,0,0,0,544,1344,544,0,0,0,0,48599,52857,16936,52857,52851,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,35921,0,0,0,0,0,0,0,0,0,0,0,48599,52851,52851,52851,52851,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,48599,48599,48599,48599,48599,48599,48599,48599,48599,48599,48599,48599,48599,52851,52851,25376,25376,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,52851,52851,52851,52851,52851,52851,52851,52851,52851,52851,52851,52851,52851,52851,52851,25376,65504,25376,25376,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,52851,16936,52851,52851,52851,52851,52851,16936,52851,52851,52851,52851,63488,63488,63488,25376,65504,65504,65504,25376,25376,65535,65535,65535,65535,65535,65535,0,0,65535,65535,0,16936,14,16936,52851,52851,52851,16936,63488,16936,52851,63488,63488,52851,52851,52851,25376,65504,65504,0,65504,65504,25376,25376,65535,65535,65535,65535,0,0,65535,65535,0,52851,17,52851,52851,52851,52851,63488,52851,52851,63488,52851,52851,52851,52851,52851,25376,65504,0,0,0,65504,65504,65504,25376,63488,63488,65535,0,0,65535,65535,0,0,14,0,0,0,63488,0,0,63488,0,0,0,0,0,0,25376,65504,65504,0,65504,65504,25376,25376,65535,65535,65535,65535,0,0,65535,65535,65535,65535,17,65535,65535,65535,63488,65535,65535,63488,65535,65535,14,17,17,14,25376,65504,65504,65504,25376,25376,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,14,65535,65535,65535,63488,63488,65535,65535,17,65535,65535,65535,65535,25376,65504,25376,25376,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,65535,17,17,65535,65535,65535,65535,14,65535,65535,65535,65535,65535,25376,25376,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,65535,65535,65535,14,17,14,17,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
char Image_text[30] = "Add.vi";

char ReadBuffer[USB_LENGTH], WriteBuffer[USB_LENGTH];

void UsbIsr() iv IVT_USB_1 ilevel 7 ics ICS_SRS {
     USB_Interrupt_Proc();
     USBIF_bit = 0;
}

void ClearBuffer (char * buffer, int length) {
     int i = 0;
     for(i=0; i<length; i++) *(buffer+i) = 0;
}

void DrawIconName(int xx, int yy) {
  int i = 0, j = 0;
  int xd = 0, yd = 0;
  int dx, dy;
  int x, y;

  dx = 320/4;
  dy = 240/3;

  x = dx/2;
  y = dy/2;

  xd = (x+xx*dx)-16;
  yd = (y+yy*dy)-16;
  TFT_Set_Brush(1, CL_WHITE, 0, 0, 0, 0);
  TFT_Set_Pen(CL_WHITE, 0);
  TFT_Rectangle(xd-18, yd+32, xd-18 + 68, yd+32 + 20);
  TFT_Set_Font(TFT_defaultFont, CL_BLACK, FO_HORIZONTAL);//CL_BLACK;
  TFT_Write_Text(Image_text, xd-18, yd+32);
}

void DrawIcon (int xx, int yy) {
  int i = 0, j = 0;
  int xd = 0, yd = 0;
  int dx, dy;
  int x, y;
  
  dx = 320/4;
  dy = 240/3;

  x = dx/2;
  y = dy/2;
  
  xd = (x+xx*dx)-16;
  yd = (y+yy*dy)-16;

  for(i=0; i<32; i++) {
      for(j=0; j<32; j++) {
          TFT_Dot(xd+i, yd+j, Image_icon[j*32+i]);
      }
  }
  DrawIconName(xx, yy);
}

void main() {
  int x0, y0;
  int i = 0, j = 0;
  
  int receive_block;
  int image_to_draw;
  
  receive_block = -1;

  USBIP0_bit = 1;
  USBIP1_bit = 1;
  USBIP2_bit = 1;

  USBIE_bit = 1;

  EnableInterrupts();

  Start_TP();

  ClearBuffer(ReadBuffer, USB_LENGTH);
  ClearBuffer(WriteBuffer, USB_LENGTH);
  HID_Enable(ReadBuffer, &WriteBuffer);

  for(i=0; i<2; i++) {
      for(j=0; j<4; j++) {
               DrawIcon(j, i);
      }
  }
  
  while (1) {
    Check_TP();
    if (HID_Read()) {
       ClearBuffer(WriteBuffer, USB_LENGTH);
       if (strstr(ReadBuffer, "AT+SEND_IMAGE")) {
            strcpy(WriteBuffer, "READY\r\n");
            HID_Write(WriteBuffer,USB_LENGTH);
           receive_block = 0;
       }

       else if ((receive_block>=0)&&(receive_block<2048)) {
            memcpy((char *)Image_icon+receive_block, ReadBuffer, USB_LENGTH);
            receive_block+=USB_LENGTH;
            if(receive_block > 2048-USB_LENGTH) strcpy(WriteBuffer, "FINISH\r\n");
            else strcpy(WriteBuffer, "NEXT\r\n");
            HID_Write(WriteBuffer,USB_LENGTH);

       }
       
       else if (strstr(&ReadBuffer, "AT+DRAW_IMAGE=")) {
            image_to_draw = ReadBuffer[strlen("AT+DRAW_IMAGE=")]-'0';
            DrawIcon(image_to_draw%4, image_to_draw/4);
            strcpy(WriteBuffer, "OK\r\n");
            HID_Write(WriteBuffer,USB_LENGTH);
       }
       else if (strstr(&ReadBuffer, "AT+SET_PAGENUM=")) {
        PageNumber.Font_Color=CL_WHITE;
        DrawLabel(&PageNumber);
        strncpy(PageNumber.Caption, &ReadBuffer + strlen("AT+SET_PAGENUM="), 29);
        PageNumber.Font_Color=CL_BLACK;
        DrawLabel(&PageNumber);
        strcpy(WriteBuffer, "OK\r\n");
        HID_Write(WriteBuffer,USB_LENGTH);
       }
       else if (strstr(&ReadBuffer, "AT+SET_ICON_NAME=")) {
        strncpy(Image_text, &ReadBuffer + strlen("AT+SET_ICON_NAME="), 29);
        strcpy(WriteBuffer, "OK\r\n");
        HID_Write(WriteBuffer,USB_LENGTH);
       }     
       else if (strstr(&ReadBuffer, "AT+DRAW_ICON_NAME=")) {
            image_to_draw = ReadBuffer[strlen("AT+DRAW_ICON_NAME=")]-'0';
            DrawIconName(image_to_draw%4, image_to_draw/4);
            strcpy(WriteBuffer, "OK\r\n");
            HID_Write(WriteBuffer,USB_LENGTH);
       }
       else if (strstr(&ReadBuffer, "PING")) {
            strcpy(WriteBuffer, "PONG\r\n");
            HID_Write(WriteBuffer,USB_LENGTH);
       }
       else {
            strcpy(WriteBuffer, "UNKNOWN\r\n");
            HID_Write(WriteBuffer,USB_LENGTH);
       }
    }
    ClearBuffer(&ReadBuffer, USB_LENGTH);
    if(receive_block > 2048-USB_LENGTH) receive_block = -1;
  }
}